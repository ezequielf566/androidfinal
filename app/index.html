<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pintando a Palavra ‚Äî Colorir</title>
  <link rel="stylesheet" href="css/style.css" />

  <style>
    /* üåÄ Tela de carregamento */
    #loadingOverlay {
      position: fixed; inset: 0;
      background: #fff9e6;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 9999;
      transition: opacity .5s ease, visibility .5s ease;
    }
    #loadingOverlay.hidden { opacity: 0; visibility: hidden; }
    .spinner {
      width: 60px; height: 60px;
      border: 6px solid #ffd54f; border-top: 6px solid transparent;
      border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text {
      font-family: "Fredoka", sans-serif;
      font-size: 1.1rem; color: #444; text-align: center;
    }

    /* üé® Popup de tons e extras */
    .palette-popup {
      position: fixed;
      background: #fff;
      border: 2px solid #ffd54f;
      border-radius: 14px;
      padding: 10px;
      display: grid;
      grid-template-columns: repeat(6, 28px);
      gap: 6px;
      box-shadow: 0 6px 16px rgba(0,0,0,.18);
      opacity: 0;
      pointer-events: none;
      transform: translateY(8px) scale(.96);
      transition: opacity .2s ease, transform .2s ease;
      z-index: 1000;
    }
    .palette-popup.active {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0) scale(1);
    }

    .extra-color {
      width: 28px; height: 28px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid rgba(0,0,0,0.1);
      box-shadow: 0 2px 4px rgba(0,0,0,.25);
      transition: transform .12s, box-shadow .2s;
    }
    .extra-color:hover { box-shadow: 0 0 6px 2px rgba(255,213,79,0.6); }
    .extra-color:active {
      transform: scale(.9);
      box-shadow: 0 0 0 3px #ffd54f;
    }

    /* üé® Bot√£o de cor personalizada (‚Äú+‚Äù) */
    .sw.custom {
      width: 36px; height: 36px;
      border-radius: 10px !important;
      background: linear-gradient(135deg,#ff9a9e,#fad0c4,#fbc2eb);
      background-size: 300% 300%;
      animation: hueShift 8s ease infinite;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 1.4rem;
      color: #fff; border: 2px solid #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,.2);
      transition: box-shadow .3s ease;
    }

    /* ‚ú® Brilho pulsante quando popup ativo */
    .sw.custom.active {
      animation: glowPulse 1.4s ease-in-out infinite;
    }

    @keyframes hueShift {
      0%,100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes glowPulse {
      0%, 100% { box-shadow: 0 0 8px 4px rgba(255,213,79,0.6); }
      50% { box-shadow: 0 0 12px 6px rgba(255,213,79,0.9); }
    }

    /* üíö Indicador profissional de salvamento */
    #saveIndicator {
      position: fixed;
      bottom: 14px;
      right: 14px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: radial-gradient(circle at center, #4CAF50 40%, rgba(76,175,80,0) 70%);
      box-shadow: 0 0 8px 2px rgba(76,175,80,0.5);
      opacity: 0;
      pointer-events: none;
      z-index: 9999;
      transform: scale(0.7);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #saveIndicator.active {
      opacity: 1;
      transform: scale(1);
      animation: pulseGlow 0.8s ease-out;
    }
    @keyframes pulseGlow {
      0% { box-shadow: 0 0 0 0 rgba(76,175,80,0.6); opacity: 0.8; }
      50% { box-shadow: 0 0 10px 6px rgba(76,175,80,0.3); opacity: 1; }
      100% { box-shadow: 0 0 0 0 rgba(76,175,80,0); opacity: 0; }
    }
  </style>
</head>

<body>
  <!-- üïì Tela de carregamento -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">üé® Carregando artes...</div>
  </div>

  <header class="topbar">
    <div id="progressWidget" class="progress-widget">
      <div class="counter">
        <span id="starCount" class="star-count">00</span>
        <span class="sep">/</span>
        <span id="totalPages" class="total-pages">00</span>
        <span class="star-icon">‚òÖ</span>
        <span id="progressPercent" class="percent">0%</span>
      </div>
      <div class="progressbar"><div id="progressFill" class="progress-fill"></div></div>
      <audio id="starSound" src="assets/sounds/estrela.mp3" preload="auto"></audio>
    </div>
  </header>

  <main class="wrap">
    <section class="stage">
      <div id="svgMount" class="svgMount"></div>
    </section>

    <section class="controls">
      <div class="palette">
        <div class="swatches" id="swatches">
          <button class="sw" data-color="#E53935" style="--c:#E53935"></button>
          <button class="sw" data-color="#FB8C00" style="--c:#FB8C00"></button>
          <button class="sw" data-color="#FDD835" style="--c:#FDD835"></button>
          <button class="sw" data-color="#7CB342" style="--c:#7CB342"></button>
          <button class="sw" data-color="#42A5F5" style="--c:#42A5F5"></button>
          <button class="sw" data-color="#8E24AA" style="--c:#8E24AA"></button>
          <button class="sw" data-color="#E0C2A2" style="--c:#E0C2A2"></button>
          <button class="sw" data-color="#8D6E63" style="--c:#8D6E63"></button>
          <button class="sw" data-color="#263238" style="--c:#263238"></button>
          <button class="sw custom" id="customColorBtn">+</button>
        </div>

        <div class="tools">
          <button id="eraserBtn" class="btn">Borracha</button>
          <button id="undoBtn" class="btn">Desfazer</button>
          <button id="redoBtn" class="btn">Refazer</button>
          <button id="savePng" class="btn primary">Salvar PNG</button>
        </div>

        <div class="pager">
          <button id="prevBtn" class="navbtn">‚óÄ</button>
          <span id="pageLabel">1 / ?</span>
          <button id="nextBtn" class="navbtn">‚ñ∂</button>
        </div>
      </div>
    </section>

    <div class="zoom-controls">
      <button id="zoom-in" class="zoom-btn">+</button>
      <button id="zoom-out" class="zoom-btn">‚àí</button>
    </div>
  </main>

  <!-- üíö Indicador de salvamento -->
  <div id="saveIndicator"></div>

  <script src="js/script.js"></script>
  <script src="js/patch-gestures-scroll.js"></script>

  <script>
    // ... (todo o bloco do seletor de cor + tela de loading permanece igual) ...

    /* ===================================================================================
       üíæ Salvamento local + Indicador (corrigido e otimizado)
       =================================================================================== */
    (function(){
      const PAINT_STORAGE_KEY = 'pp_paints_v1';
      const saveIndicator = document.getElementById("saveIndicator");

      function showSaveIndicator() {
        if (!saveIndicator) return;
        saveIndicator.classList.add("active");
        setTimeout(() => saveIndicator.classList.remove("active"), 800);
      }

      function loadSavedPaints() {
        try { return JSON.parse(localStorage.getItem(PAINT_STORAGE_KEY) || '{}'); }
        catch(e){ return {}; }
      }
      function setSavedPaints(obj){
        try { localStorage.setItem(PAINT_STORAGE_KEY, JSON.stringify(obj||{})); } catch(e){}
      }

      function savePaintState(pageId, svgEl) {
        if (!svgEl || !pageId) return;
        const paints = loadSavedPaints();
        const colored = [];
        svgEl.querySelectorAll('[fill]').forEach(el=>{
          const fill = el.getAttribute('fill');
          const orig = el.dataset && el.dataset.origFill;
          if (fill && fill !== orig && fill.toLowerCase() !== '#ffffff' && fill.toLowerCase() !== 'white') {
            const sig = el.id ? ('#'+el.id) : (el.tagName + '|' + (el.getAttribute('d')||el.getAttribute('points')||el.getAttribute('x')||'') + '|' + (el.getAttribute('y')||''));
            colored.push({ sig, fill });
          }
        });
        if (colored.length) paints[pageId] = colored; else delete paints[pageId];
        setSavedPaints(paints);
        showSaveIndicator();
      }

      function restorePaintState(pageId, svgEl){
        const paints = loadSavedPaints();
        const data = paints[pageId];
        if (!data || !svgEl) return;
        const nodes = Array.from(svgEl.querySelectorAll('*'));
        data.forEach(item=>{
          if (item.sig && item.sig[0]==='#') {
            const byId = svgEl.querySelector(item.sig);
            if (byId) { byId.setAttribute('fill', item.fill); return; }
          }
          const [tag, a, b] = (item.sig||'').split('|');
          const el = nodes.find(n=>{
            if ((n.tagName||'').toLowerCase() !== (tag||'').toLowerCase()) return false;
            const valA = n.getAttribute('d')||n.getAttribute('points')||n.getAttribute('x')||'';
            const valB = n.getAttribute('y')||'';
            return (valA===a && valB===b);
          });
          if (el) el.setAttribute('fill', item.fill);
        });
      }

      window.savePaintState = savePaintState;
      window.restorePaintState = restorePaintState;

      const mount = document.getElementById('svgMount');
      const svgObserver = new MutationObserver(()=>{
        const svg = mount.querySelector('svg');
        if (!svg) return;
        setTimeout(()=>{
          try {
            const pid = typeof window.pageId === 'function' ? window.pageId() : null;
            restorePaintState(pid, svg);
            enableAttrObserver(); // ‚úÖ reativa o observer ap√≥s troca de p√°gina
          } catch(_) {}
        }, 0);
      });
      svgObserver.observe(mount, { childList:true, subtree:true });

      let saveTimer = null;
      const attrObserver = new MutationObserver((muts)=>{
        const touched = muts.some(m=> m.type==='attributes' && m.attributeName==='fill');
        if (!touched) return;
        clearTimeout(saveTimer);
        saveTimer = setTimeout(()=>{
          try{
            const pid = typeof window.pageId === 'function' ? window.pageId() : null;
            const svg = mount.querySelector('svg');
            savePaintState(pid, svg);
          }catch(_){}
        }, 120);
      });

      function enableAttrObserver(){
        const svg = mount.querySelector('svg');
        if (svg) attrObserver.observe(svg, { attributes:true, subtree:true, attributeFilter:['fill'] });
      }

      // inicial com pequeno delay para garantir SVG carregado
      setTimeout(enableAttrObserver, 600);

      // fallback: salva tamb√©m ao trocar cor no seletor
      window.addEventListener('colorchange', ()=>{
        const svg = mount.querySelector('svg');
        const pid = typeof window.pageId === 'function' ? window.pageId() : null;
        if (svg && pid) savePaintState(pid, svg);
      });
    })();
  </script>
</body>
</html>
